<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATT Test - Bilgoo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border-color: #ffeaa7; color: #856404; }
        .info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover { background: #0056b3; }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ App Tracking Transparency Test</h1>
    <p>Bu sayfa iOS'ta ATT framework'Ã¼nÃ¼n doÄŸru Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± test eder.</p>

    <div id="platform-info" class="status info">
        <strong>Platform:</strong> <span id="platform">Kontrol ediliyor...</span><br>
        <strong>Capacitor:</strong> <span id="capacitor">Kontrol ediliyor...</span><br>
        <strong>ATT Plugin:</strong> <span id="att-plugin">Kontrol ediliyor...</span>
    </div>

    <div id="att-status" class="status warning">
        <strong>ATT Durumu:</strong> <span id="status-text">HenÃ¼z kontrol edilmedi</span>
    </div>

    <div class="controls">
        <button onclick="checkATTStatus()">ATT Durumunu Kontrol Et</button>
        <button onclick="requestATTPermission()">ATT Ä°zni Ä°ste</button>
        <button onclick="testAdMob()">AdMob Test Et</button>
        <button onclick="clearLog()">Logi Temizle</button>
    </div>

    <div id="log" class="log">Test loglarÄ± burada gÃ¶rÃ¼necek...\n</div>

    <script>
        let logElement = document.getElementById('log');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            logElement.textContent = 'Log temizlendi...\n';
        }
        
        // Platform bilgilerini kontrol et
        function checkPlatform() {
            const platform = window.Capacitor ? window.Capacitor.getPlatform() : 'web';
            const isCapacitorAvailable = !!window.Capacitor;
            const isATTAvailable = !!(window.Capacitor?.Plugins?.ATTrackingManager);
            
            document.getElementById('platform').textContent = platform;
            document.getElementById('capacitor').textContent = isCapacitorAvailable ? 'âœ… Mevcut' : 'âŒ Mevcut deÄŸil';
            document.getElementById('att-plugin').textContent = isATTAvailable ? 'âœ… Mevcut' : 'âŒ Mevcut deÄŸil';
            
            log(`Platform: ${platform}`);
            log(`Capacitor: ${isCapacitorAvailable ? 'Mevcut' : 'Mevcut deÄŸil'}`);
            log(`ATT Plugin: ${isATTAvailable ? 'Mevcut' : 'Mevcut deÄŸil'}`);
            
            if (platform !== 'ios') {
                log('âš ï¸ ATT sadece iOS\'ta Ã§alÄ±ÅŸÄ±r');
            }
            
            return { platform, isCapacitorAvailable, isATTAvailable };
        }
        
        // ATT durumunu kontrol et
        async function checkATTStatus() {
            log('ğŸ” ATT durumu kontrol ediliyor...');
            
            const platformInfo = checkPlatform();
            
            if (platformInfo.platform !== 'ios') {
                updateStatus('warning', 'iOS olmayan platform - ATT gerekmiyor');
                return;
            }
            
            if (!platformInfo.isATTAvailable) {
                updateStatus('error', 'ATT Plugin bulunamadÄ±');
                log('âŒ ATTrackingManager plugin yÃ¼klÃ¼ deÄŸil');
                return;
            }
            
            try {
                const ATTrackingManager = window.Capacitor.Plugins.ATTrackingManager;
                const result = await ATTrackingManager.getTrackingAuthorizationStatus();
                
                log(`ğŸ“Š ATT Durumu: ${result.status}`);
                
                let statusClass, statusText;
                switch (result.status) {
                    case 'authorized':
                        statusClass = 'success';
                        statusText = 'âœ… Ä°zin verildi - Tracking aktif';
                        break;
                    case 'denied':
                        statusClass = 'error';
                        statusText = 'âŒ Ä°zin reddedildi - Tracking devre dÄ±ÅŸÄ±';
                        break;
                    case 'restricted':
                        statusClass = 'error';
                        statusText = 'ğŸš« KÄ±sÄ±tlanmÄ±ÅŸ - Tracking devre dÄ±ÅŸÄ±';
                        break;
                    case 'notDetermined':
                        statusClass = 'warning';
                        statusText = 'â“ HenÃ¼z sorulmadÄ± - Ä°zin iste butonunu kullan';
                        break;
                    default:
                        statusClass = 'error';
                        statusText = `â“ Bilinmeyen durum: ${result.status}`;
                }
                
                updateStatus(statusClass, statusText);
                
            } catch (error) {
                log(`âŒ ATT durum kontrolÃ¼ hatasÄ±: ${error.message}`);
                updateStatus('error', `Hata: ${error.message}`);
            }
        }
        
        // ATT izni iste
        async function requestATTPermission() {
            log('ğŸ™‹â€â™‚ï¸ ATT izni isteniyor...');
            
            const platformInfo = checkPlatform();
            
            if (platformInfo.platform !== 'ios') {
                log('âš ï¸ ATT izni sadece iOS\'ta istenebilir');
                return;
            }
            
            if (!platformInfo.isATTAvailable) {
                log('âŒ ATTrackingManager plugin yÃ¼klÃ¼ deÄŸil');
                return;
            }
            
            try {
                const ATTrackingManager = window.Capacitor.Plugins.ATTrackingManager;
                
                // Ã–nce mevcut durumu kontrol et
                const currentStatus = await ATTrackingManager.getTrackingAuthorizationStatus();
                log(`ğŸ“Š Mevcut durum: ${currentStatus.status}`);
                
                if (currentStatus.status !== 'notDetermined') {
                    log('âš ï¸ Ä°zin daha Ã¶nce cevaplanmÄ±ÅŸ, tekrar sorulmayacak');
                    log('ğŸ’¡ Settings > Privacy & Security > Tracking\'den manuel olarak deÄŸiÅŸtirilebilir');
                    return;
                }
                
                // Ä°zin iste
                log('ğŸ“± ATT izin dialogu gÃ¶steriliyor...');
                const result = await ATTrackingManager.requestTrackingAuthorization();
                
                log(`ğŸ“‹ Ä°zin sonucu: ${result.status}`);
                
                // Durumu gÃ¼ncelle
                await checkATTStatus();
                
            } catch (error) {
                log(`âŒ ATT izin isteÄŸi hatasÄ±: ${error.message}`);
            }
        }
        
        // AdMob test et
        async function testAdMob() {
            log('ğŸ¯ AdMob test ediliyor...');
            
            if (!window.Capacitor?.Plugins?.AdMob) {
                log('âŒ AdMob plugin bulunamadÄ±');
                return;
            }
            
            try {
                const AdMob = window.Capacitor.Plugins.AdMob;
                
                // ATT durumuna gÃ¶re initialize et
                const attStatus = await getCurrentATTStatus();
                const trackingAllowed = attStatus === 'authorized' || attStatus === 'notRequired';
                
                log(`ğŸ“Š Tracking allowed: ${trackingAllowed}`);
                
                const initOptions = {
                    requestTrackingAuthorization: false, // Manuel olarak hallediyoruz
                    testingDevices: [],
                    initializeForTesting: false,
                    tagForChildDirectedTreatment: false,
                    tagForUnderAgeOfConsent: false,
                    maxAdContentRating: 'MA',
                    npa: trackingAllowed ? '0' : '1'
                };
                
                log('ğŸš€ AdMob baÅŸlatÄ±lÄ±yor...');
                await AdMob.initialize(initOptions);
                log('âœ… AdMob baÅŸarÄ±yla baÅŸlatÄ±ldÄ±');
                
            } catch (error) {
                log(`âŒ AdMob test hatasÄ±: ${error.message}`);
            }
        }
        
        // Helper fonksiyon
        async function getCurrentATTStatus() {
            try {
                const platform = window.Capacitor ? window.Capacitor.getPlatform() : 'web';
                if (platform !== 'ios') return 'notRequired';
                
                const ATTrackingManager = window.Capacitor?.Plugins?.ATTrackingManager;
                if (!ATTrackingManager) return 'unavailable';
                
                const result = await ATTrackingManager.getTrackingAuthorizationStatus();
                return result.status;
            } catch (error) {
                return 'error';
            }
        }
        
        function updateStatus(className, text) {
            const statusElement = document.getElementById('att-status');
            statusElement.className = `status ${className}`;
            document.getElementById('status-text').textContent = text;
        }
        
        // Sayfa yÃ¼klendiÄŸinde otomatik kontrol
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ ATT Test sayfasÄ± yÃ¼klendi');
            
            // Capacitor ready'i bekle
            if (window.Capacitor) {
                checkPlatform();
            } else {
                setTimeout(() => {
                    log('â° Capacitor bekleniyor...');
                    checkPlatform();
                }, 1000);
            }
        });
        
        // ATTManager event'ini dinle
        window.addEventListener('attStatusReady', function(event) {
            log(`ğŸ‰ ATTManager event alÄ±ndÄ±: ${event.detail.status}`);
        });
    </script>
</body>
</html>
